<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Chain DEX Sniping Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1b3e 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .dashboard {
            min-height: 100vh;
            display: grid;
            grid-template-areas: 
                "header header header header"
                "stats stats stats stats"
                "opportunities chains analytics watchlist"
                "recent recent recent recent";
            grid-template-columns: 1fr 300px 300px 300px;
            grid-template-rows: auto auto 1fr auto;
            gap: 20px;
            padding: 20px;
        }

        .header {
            grid-area: header;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(45deg, #00d4ff, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            grid-area: stats;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #00ff88;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .opportunities {
            grid-area: opportunities;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .opportunity-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .opportunity-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .opportunity-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .token-symbol {
            font-weight: 700;
            font-size: 16px;
        }

        .risk-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-low { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .risk-medium { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .risk-high { background: rgba(255, 107, 53, 0.2); color: #ff6b35; }
        .risk-critical { background: rgba(220, 53, 69, 0.2); color: #dc3545; }

        .opportunity-details {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        .chain-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 11px;
            margin-right: 5px;
        }

        .chain-ethereum { background: rgba(98, 126, 234, 0.2); color: #627eea; }
        .chain-base { background: rgba(0, 82, 255, 0.2); color: #0052ff; }
        .chain-solana { background: rgba(220, 31, 255, 0.2); color: #dc1fff; }

        .chains-panel {
            grid-area: chains;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chain-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chain-item:last-child {
            border-bottom: none;
        }

        .chain-name {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chain-stats {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .analytics-panel {
            grid-area: analytics;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analytics-chart {
            padding: 20px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Watchlist Panel Styles */
        .watchlist-panel {
            grid-area: watchlist;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .watchlist-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .watchlist-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .watchlist-details {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        .watch-button {
            background: linear-gradient(45deg, #ffc107, #ffb300);
            color: #000;
            font-weight: 600;
        }

        .watch-button:hover {
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
        }

        .recent-trades {
            grid-area: recent;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th,
        .trades-table td {
            padding: 12px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .trades-table th {
            background: rgba(255, 255, 255, 0.02);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-button {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 5px;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.3);
        }

        .action-button.danger {
            background: linear-gradient(45deg, #ff6b35, #cc5529);
        }

        .action-button.danger:hover {
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .recommendation {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .rec-strong-buy { background: rgba(0, 255, 136, 0.3); color: #00ff88; }
        .rec-buy { background: rgba(0, 212, 255, 0.3); color: #00d4ff; }
        .rec-watch { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
        .rec-avoid { background: rgba(255, 107, 53, 0.3); color: #ff6b35; }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease;
        }
        
        .notification-success { border-left-color: #00ff88; }
        .notification-error { border-left-color: #ff6b35; }
        .notification-info { border-left-color: #00d4ff; }
        
        .notification button {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0 4px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Mobile responsiveness */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-areas: 
                    "header"
                    "stats"
                    "opportunities"
                    "watchlist"
                    "chains"
                    "analytics"
                    "recent";
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>Multi-Chain DEX Sniping Dashboard</h1>
            <p>Real-time monitoring across Ethereum, Base, and Solana</p>
            <div class="header-controls">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Auto-Refresh Active</span>
                </div>
                <div class="controls">
                    <button class="action-button" onclick="toggleAutoRefresh()">
                        <span id="auto-refresh-btn-text">Disable Auto-Refresh</span>
                    </button>
                    <button class="action-button" onclick="refreshData()">
                        <div class="loading" id="refresh-spinner" style="display:none;"></div>
                        <span id="refresh-text">Manual Refresh</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-opportunities">0</div>
                <div class="stat-label">Total Opportunities</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="high-confidence">0</div>
                <div class="stat-label">High Confidence</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-chains">0</div>
                <div class="stat-label">Active Chains</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="analysis-rate">0</div>
                <div class="stat-label">Analysis/Min</div>
            </div>
        </div>

        <!-- Opportunities Panel -->
        <div class="opportunities">
            <div class="section-header">
                <span>Live Opportunities</span>
                <span class="controls">
                    <button class="action-button" onclick="clearOpportunities()">Clear</button>
                </span>
            </div>
            <div class="opportunity-list" id="opportunity-list">
                <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">
                    <div class="loading"></div>
                    <p>Loading opportunities...</p>
                </div>
            </div>
        </div>

        <!-- Chains Panel -->
        <div class="chains-panel">
            <div class="section-header">
                <span>Chain Status</span>
            </div>
            <div class="chain-item">
                <div class="chain-name">
                    <span class="chain-badge chain-ethereum">ETH</span>
                    Ethereum
                    <span style="margin-left: auto; color: #00ff88;">●</span>
                </div>
                <div class="chain-stats" id="eth-stats">Active</div>
            </div>
            <div class="chain-item">
                <div class="chain-name">
                    <span class="chain-badge chain-base">BASE</span>
                    Base
                    <span style="margin-left: auto; color: #00ff88;">●</span>
                </div>
                <div class="chain-stats" id="base-stats">Active</div>
            </div>
            <div class="chain-item">
                <div class="chain-name">
                    <span class="chain-badge chain-solana">SOL</span>
                    Solana
                    <span style="margin-left: auto; color: #00ff88;">●</span>
                </div>
                <div class="chain-stats" id="sol-stats">Active</div>
            </div>
        </div>

        <!-- Analytics Panel -->
        <div class="analytics-panel">
            <div class="section-header">
                <span>Analytics</span>
            </div>
            <div class="analytics-chart">
                Auto-refreshing every 5 seconds
            </div>
        </div>

        <!-- Watchlist Panel -->
        <div class="watchlist-panel">
            <div class="section-header">
                <span>Watchlist</span>
                <span class="controls">
                    <button class="action-button" onclick="loadWatchlist()">Refresh</button>
                </span>
            </div>
            <div id="watchlist-container" class="watchlist-container">
                <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">
                    <div class="loading"></div>
                    <p>Loading watchlist...</p>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-trades">
            <div class="section-header">
                <span>Recent Analysis</span>
            </div>
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Token</th>
                        <th>Chain</th>
                        <th>Risk</th>
                        <th>Recommendation</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="recent-activity">
                    <tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">Loading recent activity...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    // Dashboard state
    let dashboardData = {
        opportunities: [],
        recentActivity: [],
        stats: {
            totalOpportunities: 0,
            highConfidence: 0,
            activeChains: 3,
            analysisRate: 0
        }
    };

    // Auto-refresh settings
    let autoRefreshEnabled = true;
    let autoRefreshTimer;
    let ws;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    // Watchlist functionality
    function addToWatchlistFromOpp(opportunityIndex) {
        const opp = dashboardData.opportunities[opportunityIndex];
        if (!opp) {
            showNotification('Opportunity not found', 'error');
            return;
        }
        
        const data = {
            token_symbol: opp.token.symbol,
            token_address: opp.token.address,
            chain: opp.chain.toUpperCase(),
            reason: `Added from dashboard - ${new Date().toLocaleString()}`,
            notes: `Manual addition via web interface`,
            liquidity_usd: opp.liquidity?.liquidity_usd || 0,
            dex_name: opp.liquidity?.dex_name || 'Unknown',
            pair_address: opp.liquidity?.pair_address || '',
            recommendation: {
                action: opp.recommendation,
                confidence: opp.confidence,
                score: opp.score
            }
        };
        
        addToWatchlist(data);
    }

    function addToWatchlist(data) {
        fetch('/api/watchlist/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification(`${data.token_symbol} added to watchlist`, 'success');
                loadWatchlist(); // Refresh watchlist display
            } else {
                showNotification(`Failed to add ${data.token_symbol}: ${result.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error adding to watchlist:', error);
            showNotification(`Error adding ${data.token_symbol} to watchlist`, 'error');
        });
    }

    function removeFromWatchlist(tokenAddress, chain, tokenSymbol) {
        fetch(`/api/watchlist/remove?token_address=${tokenAddress}&chain=${chain}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showNotification(`${tokenSymbol} removed from watchlist`, 'success');
                loadWatchlist(); // Refresh watchlist display
            } else {
                showNotification(`Failed to remove ${tokenSymbol}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error removing from watchlist:', error);
            showNotification(`Error removing ${tokenSymbol}`, 'error');
        });
    }

    function loadWatchlist() {
        fetch('/api/watchlist')
            .then(response => response.json())
            .then(data => {
                renderWatchlist(data.items || []);
            })
            .catch(error => {
                console.error('Error loading watchlist:', error);
                const container = document.getElementById('watchlist-container');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">Error loading watchlist</div>';
                }
            });
    }

    function renderWatchlist(items) {
        const container = document.getElementById('watchlist-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (items.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No items in watchlist...</div>';
            return;
        }
        
        items.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'watchlist-item';
            
            const chainClass = item.chain ? item.chain.toLowerCase() : 'unknown';
            const addedDate = item.added_at ? new Date(item.added_at).toLocaleDateString() : 'Unknown';
            const score = item.score || 0;
            
            itemElement.innerHTML = `
                <div class="watchlist-header">
                    <span class="token-symbol">${item.token_symbol || 'Unknown'}</span>
                    <span class="risk-badge risk-${item.risk_level || 'medium'}">${(item.risk_level || 'medium').toUpperCase()}</span>
                </div>
                <div class="watchlist-details">
                    <span class="chain-badge chain-${chainClass}">${(item.chain || 'UNKNOWN').toUpperCase()}</span>
                    Added: ${addedDate} | Score: ${score.toFixed(2)}
                    ${item.reason ? `<br>Reason: ${item.reason}` : ''}
                    <div style="margin-top: 8px;">
                        <button class="action-button" onclick="executeTrade('${item.token_symbol}')">Trade</button>
                        <button class="action-button danger" onclick="removeFromWatchlist('${item.token_address}', '${item.chain}', '${item.token_symbol}')">Remove</button>
                    </div>
                </div>
            `;
            container.appendChild(itemElement);
        });
    }

    // Initialize dashboard
    function initDashboard() {
        console.log('Initializing dashboard...');
        updateStats();
        renderOpportunities();
        renderRecentActivity();
        loadWatchlist(); // Load watchlist on startup
        startAutoRefresh();
        connectWebSocket();
        console.log('Dashboard initialized');
    }

    // Auto-refresh functionality
    function startAutoRefresh() {
        if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        console.log('Starting auto-refresh (5s interval)');
        loadRealData();
        autoRefreshTimer = setInterval(() => {
            if (autoRefreshEnabled) {
                console.log('Auto-refreshing...');
                loadRealData();
                updateAgeTimestamps();
            }
        }, 5000);
    }

    function toggleAutoRefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const btn = document.getElementById('auto-refresh-btn-text');
        const indicator = document.querySelector('.status-indicator span');
        if (autoRefreshEnabled) {
            btn.textContent = 'Disable Auto-Refresh';
            indicator.textContent = 'Auto-Refresh Active';
            console.log('Auto-refresh enabled');
        } else {
            btn.textContent = 'Enable Auto-Refresh';
            indicator.textContent = 'Auto-Refresh Disabled';
            console.log('Auto-refresh disabled');
        }
    }

    // Load real data from API
    // Update the loadRealData function
    async function loadRealData() {
        try {
            console.log('Loading data from API...');
            
            // Load opportunities with error handling
            try {
                const opportunitiesResponse = await fetch('/api/opportunities');
                if (opportunitiesResponse.ok) {
                    const opportunities = await opportunitiesResponse.json();
                    console.log(`Loaded ${opportunities.length} opportunities`);
                    
                    if (opportunities && opportunities.length > 0) {
                        dashboardData.opportunities = opportunities.map(opp => ({
                            token: { 
                                symbol: opp.token_symbol || 'UNKNOWN', 
                                address: opp.token_address || ''
                            },
                            chain: (opp.chain || 'ethereum').toLowerCase(),
                            risk: opp.risk_level || 'unknown',
                            recommendation: opp.recommendation || 'UNKNOWN',
                            confidence: opp.confidence || 'UNKNOWN',
                            score: opp.score || 0,
                            liquidity: opp.liquidity_usd ? `$${(opp.liquidity_usd / 1000).toFixed(0)}K` : '$0K',
                            age: `${opp.age_minutes || 0}m`,
                            detected_at: new Date(Date.now() - (opp.age_minutes || 0) * 60000)
                        }));
                    } else {
                        console.log('No opportunities available yet');
                    }
                } else {
                    console.error('Failed to load opportunities:', opportunitiesResponse.status);
                }
            } catch (error) {
                console.error('Error loading opportunities:', error);
            }
            
            // Load stats with error handling
            try {
                const statsResponse = await fetch('/api/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    console.log('Loaded stats:', stats);
                    
                    dashboardData.stats = {
                        totalOpportunities: stats.total_opportunities || 0,
                        highConfidence: stats.high_confidence || 0,
                        activeChains: stats.active_chains || 3,
                        analysisRate: stats.analysis_rate || 0
                    };
                } else {
                    console.error('Failed to load stats:', statsResponse.status);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
            
            // Load trade history with error handling
            try {
                const tradesResponse = await fetch('/api/trades');
                if (tradesResponse.ok) {
                    const tradesData = await tradesResponse.json();
                    console.log(`Loaded ${tradesData.trades?.length || 0} trades`);
                    
                    if (tradesData.trades && tradesData.trades.length > 0) {
                        dashboardData.recentActivity = tradesData.trades.slice(0, 20).map(trade => ({
                            time: new Date(trade.created_at).toLocaleTimeString(),
                            token: trade.token_symbol || 'UNKNOWN',
                            chain: (trade.chain || 'ethereum').toLowerCase(),
                            risk: 'unknown',
                            recommendation: trade.trade_type || 'UNKNOWN',
                            status: trade.status || 'unknown'
                        }));
                    }
                } else {
                    console.error('Failed to load trades:', tradesResponse.status);
                }
            } catch (error) {
                console.error('Error loading trades:', error);
            }
            
            // Update displays
            updateStats();
            renderOpportunities();
            renderRecentActivity();
            
            console.log('Data load complete');
            
        } catch (error) {
            console.error('Failed to load data:', error);
            showNotification('Failed to refresh data', 'error');
        }
    }

    // Improve the WebSocket connection with reconnection logic
    function connectWebSocket() {
        try {
            console.log('Connecting WebSocket...');
            
            // Close existing connection if any
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            ws = new WebSocket('ws://localhost:8000/ws');
            
            ws.onopen = function(event) {
                console.log('WebSocket connected successfully');
                reconnectAttempts = 0;
                
                // Subscribe to updates
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    topics: ['opportunities', 'trades', 'stats']
                }));
                
                // Clear any connection error notifications
                const notifications = document.getElementById('notifications');
                if (notifications) {
                    const errorNotifs = notifications.querySelectorAll('.notification-error');
                    errorNotifs.forEach(n => n.remove());
                }
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    console.log('WebSocket message:', message.type);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                
                // Update status indicator
                const statusDot = document.querySelector('.status-dot');
                if (statusDot) {
                    statusDot.style.background = '#ff6b35';
                }
                
                // Attempt reconnection
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(3000 * reconnectAttempts, 30000);
                    console.log(`Reconnecting in ${delay/1000}s... (attempt ${reconnectAttempts})`);
                    setTimeout(connectWebSocket, delay);
                } else {
                    showNotification('WebSocket connection lost. Please refresh the page.', 'error');
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
            
        } catch (error) {
            console.error('Failed to connect WebSocket:', error);
            showNotification('Real-time updates unavailable', 'error');
        }
    }








    function updateAgeTimestamps() {
        dashboardData.opportunities.forEach(opp => {
            if (opp.detected_at) {
                const ageMinutes = Math.floor((Date.now() - opp.detected_at.getTime()) / 60000);
                opp.age = `${ageMinutes}m`;
            }
        });
        renderOpportunities();
    }

    // API request function
    async function apiRequest(endpoint, options = {}) {
        try {
            const response = await fetch(`/api${endpoint}`, {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            });
            if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error('API request failed:', error);
            throw error;
        }
    }

    // WebSocket connection
    function connectWebSocket() {
        try {
            console.log('Connecting WebSocket...');
            ws = new WebSocket('ws://localhost:8000/ws');
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    topics: ['opportunities', 'trades', 'stats']
                }));
            };
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('WebSocket message:', message.type);
                handleWebSocketMessage(message);
            };
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`);
                    setTimeout(connectWebSocket, 3000 * reconnectAttempts);
                }
            };
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        } catch (error) {
            console.error('Failed to connect WebSocket:', error);
        }
    }

    function handleWebSocketMessage(message) {
        switch (message.type) {
            case 'new_opportunity':
                console.log('New opportunity via WebSocket:', message.data.token_symbol);
                loadRealData();
                showNotification(`New opportunity: ${message.data.token_symbol}`, 'success');
                break;
            case 'trade_executed':
                showNotification(`Trade executed: ${message.data.token_symbol}`, 'success');
                break;
            case 'watchlist_updated':
                console.log('Watchlist updated via WebSocket');
                loadWatchlist(); // Refresh watchlist
                if (message.data.action === 'added') {
                    showNotification(`${message.data.token_symbol} added to watchlist`, 'info');
                }
                break;
            case 'stats_update':
                updateStatsFromWS(message.data);
                break;
            case 'subscribed':
                console.log('Subscribed to WebSocket updates');
                break;
            default:
                console.log('Unknown message type:', message.type);
        }
    }

    function updateStatsFromWS(data) {
        Object.assign(dashboardData.stats, data);
        updateStats();
    }

    // Update statistics
    function updateStats() {
        document.getElementById('total-opportunities').textContent = dashboardData.stats.totalOpportunities;
        document.getElementById('high-confidence').textContent = dashboardData.stats.highConfidence;
        document.getElementById('active-chains').textContent = dashboardData.stats.activeChains;
        document.getElementById('analysis-rate').textContent = dashboardData.stats.analysisRate;
    }

    // Render opportunities
    function renderOpportunities() {
        const container = document.getElementById('opportunity-list');
        container.innerHTML = '';
        if (dashboardData.opportunities.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No opportunities detected yet...</div>';
            return;
        }
        dashboardData.opportunities.forEach((opp, index) => {
            const item = document.createElement('div');
            item.className = 'opportunity-item';
            item.innerHTML = `
                <div class="opportunity-header">
                    <span class="token-symbol">${opp.token.symbol}</span>
                    <span class="risk-badge risk-${opp.risk}">${opp.risk}</span>
                </div>
                <div class="opportunity-details">
                    <span class="chain-badge chain-${opp.chain}">${opp.chain.toUpperCase()}</span>
                    Score: ${opp.score.toFixed(2)} | Liquidity: ${opp.liquidity} | Age: ${opp.age}
                    <span class="recommendation rec-${opp.recommendation.toLowerCase().replace('_', '-')}">${opp.recommendation}</span>
                    <div style="margin-top: 8px;">
                        <button class="action-button" onclick="executeTrade('${opp.token.symbol}')">Trade</button>
                        <button class="action-button watch-button" onclick="addToWatchlistFromOpp(${index})">Watch</button>
                        <button class="action-button" onclick="viewTokenDetails(${index})">Details</button>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    // Enhanced viewTokenDetails/modal system
    function viewTokenDetails(opportunityIndex) {
        const opp = dashboardData.opportunities[opportunityIndex];
        if (!opp) {
            showNotification('Opportunity not found', 'error');
            return;
        }
        showTokenDetailsModal(opp, opportunityIndex);
    }

    function showTokenDetailsModal(opportunity, opportunityIndex) {
        // Remove existing modal if any
        const existingModal = document.getElementById('token-details-modal');
        if (existingModal) existingModal.remove();

        const token = opportunity.token || {};
        const recommendation = opportunity.metadata?.recommendation || {};
        const reasons = Array.isArray(recommendation.reasons) ? recommendation.reasons : [];
        const warnings = Array.isArray(recommendation.warnings) ? recommendation.warnings : [];
        const liquidity = opportunity.liquidity || {};
        const chain = (opportunity.chain || '').toUpperCase();

        // Modal HTML
        const modal = document.createElement('div');
        modal.id = 'token-details-modal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>${token.symbol || 'Unknown Token'} - Detailed Analysis</h2>
                    <button class="modal-close" onclick="closeTokenDetailsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <h3>Token Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item"><label>Symbol:</label><span>${token.symbol || 'Unknown'}</span></div>
                            <div class="detail-item"><label>Name:</label><span>${token.name || 'Unknown'}</span></div>
                            <div class="detail-item">
                                <label>Address:</label>
                                <span class="address-text">${token.address || 'Unknown'}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${token.address || ''}')">Copy</button>
                            </div>
                            <div class="detail-item"><label>Chain:</label><span class="chain-badge chain-${chain.toLowerCase()}">${chain}</span></div>
                            <div class="detail-item"><label>Detected:</label><span>${opportunity.detected_at ? new Date(opportunity.detected_at).toLocaleString() : 'Unknown'}</span></div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Risk Analysis</h3>
                        <div class="detail-grid">
                            <div class="detail-item"><label>Risk Level:</label><span class="risk-badge risk-${opportunity.risk}">${(opportunity.risk || '').toUpperCase()}</span></div>
                            <div class="detail-item"><label>Security Score:</label><span>${opportunity.score ? opportunity.score.toFixed(3) : 'N/A'}/1.0</span></div>
                            <div class="detail-item"><label>Recommendation:</label><span class="recommendation rec-${(opportunity.recommendation || '').toLowerCase().replace('_', '-')}">${opportunity.recommendation || 'N/A'}</span></div>
                            <div class="detail-item"><label>Confidence:</label><span>${opportunity.confidence || 'N/A'}</span></div>
                        </div>
                        ${warnings.length > 0 ? `
                        <div class="warnings-section">
                            <h4>Risk Warnings</h4>
                            <ul class="warning-list">${warnings.map(warning => `<li>${warning}</li>`).join('')}</ul>
                        </div>` : ''}
                    </div>
                    <div class="detail-section">
                        <h3>Liquidity Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item"><label>DEX:</label><span>${liquidity.dex_name || 'Unknown'}</span></div>
                            <div class="detail-item"><label>Liquidity USD:</label><span>$${liquidity.liquidity_usd ? liquidity.liquidity_usd.toLocaleString() : 'N/A'}</span></div>
                            <div class="detail-item">
                                <label>Pair Address:</label>
                                <span class="address-text">${liquidity.pair_address || 'N/A'}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${liquidity.pair_address || ''}')">Copy</button>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h3>Trading Recommendation</h3>
                        <div class="recommendation-box rec-${(opportunity.recommendation || '').toLowerCase().replace('_', '-')}">
                            <div class="rec-header">
                                <span class="rec-action">${opportunity.recommendation || 'N/A'}</span>
                                <span class="rec-confidence">${recommendation.confidence || 'UNKNOWN'} Confidence</span>
                            </div>
                            <div class="rec-score">Score: ${opportunity.score ? opportunity.score.toFixed(3) : 'N/A'}</div>
                            ${reasons.length > 0 ? `
                            <div class="reasons-section">
                                <h4>Positive Factors</h4>
                                <ul class="reason-list">${reasons.map(reason => `<li>${reason}</li>`).join('')}</ul>
                            </div>` : ''}
                        </div>
                    </div>
                    ${(chain.includes('SOLANA') || opportunity.metadata?.solana_source) ? `
                    <div class="detail-section">
                        <h3>Solana Specific</h3>
                        <div class="detail-grid">
                            ${opportunity.metadata?.solana_source ? `<div class="detail-item"><label>Source:</label><span>${opportunity.metadata.solana_source}</span></div>` : ''}
                            ${opportunity.metadata?.market_cap_usd ? `<div class="detail-item"><label>Market Cap:</label><span>$${opportunity.metadata.market_cap_usd.toLocaleString()}</span></div>` : ''}
                            ${opportunity.metadata?.volume_24h_usd ? `<div class="detail-item"><label>Volume 24h:</label><span>$${opportunity.metadata.volume_24h_usd.toLocaleString()}</span></div>` : ''}
                        </div>
                    </div>` : ''}
                    <div class="detail-section">
                        <h3>External Links</h3>
                        <div class="link-buttons">
                            ${chain.includes('ETHEREUM') ? `
                                <a href="https://etherscan.io/token/${token.address}" target="_blank" class="external-link">View on Etherscan</a>
                                <a href="https://dexscreener.com/ethereum/${token.address}" target="_blank" class="external-link">View on DexScreener</a>
                            ` : ''}
                            ${chain.includes('BASE') ? `
                                <a href="https://basescan.org/token/${token.address}" target="_blank" class="external-link">View on BaseScan</a>
                                <a href="https://dexscreener.com/base/${token.address}" target="_blank" class="external-link">View on DexScreener</a>
                            ` : ''}
                            ${chain.includes('SOLANA') ? `
                                <a href="https://solscan.io/token/${token.address}" target="_blank" class="external-link">View on Solscan</a>
                                <a href="https://dexscreener.com/solana/${token.address}" target="_blank" class="external-link">View on DexScreener</a>
                            ` : ''}
                            <a href="https://www.coingecko.com/en/search_redirect?id=${token.symbol}" target="_blank" class="external-link">Search on CoinGecko</a>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="action-button" onclick="executeTrade('${token.symbol}')">Execute Trade</button>
                    <button class="action-button watch-button" onclick="addToWatchlistFromOpp(${opportunityIndex}); closeTokenDetailsModal();">Add to Watchlist</button>
                    <button class="action-button danger" onclick="closeTokenDetailsModal()">Close</button>
                </div>
            </div>
        `;

        // Add styles for modal if not present
        if (!document.getElementById('modal-styles')) {
            document.head.insertAdjacentHTML('beforeend', `
                <style id="modal-styles">
                    .modal-overlay {
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
                        z-index: 1000; display: flex; justify-content: center; align-items: center;
                        animation: fadeIn 0.3s ease;
                    }
                    .modal-content {
                        background: linear-gradient(135deg, #1a1b3e 0%, #2a2b4e 100%);
                        border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1);
                        max-width: 800px; max-height: 90vh; width: 90%; overflow-y: auto;
                        animation: slideIn 0.3s ease;
                    }
                    .modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
                    .modal-header h2 { margin: 0; color: #00d4ff; font-size: 24px; }
                    .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;}
                    .modal-close:hover { background: rgba(255,255,255,0.1); }
                    .modal-body { padding: 20px; }
                    .detail-section { margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);}
                    .detail-section h3 { margin: 0 0 15px 0; color: #00ff88; font-size: 18px; border-bottom: 1px solid rgba(0,255,136,0.3); padding-bottom: 8px; }
                    .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
                    .detail-item { display: flex; flex-direction: column; gap: 5px; }
                    .detail-item label { font-weight: 600; color: rgba(255,255,255,0.7); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
                    .detail-item span { color: white; font-size: 16px; }
                    .address-text { font-family: monospace; word-break: break-all; font-size: 14px !important; color: #00d4ff !important; }
                    .copy-btn { background: rgba(0,212,255,0.2); border: 1px solid rgba(0,212,255,0.5); color: #00d4ff; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px; align-self: flex-start; }
                    .copy-btn:hover { background: rgba(0,212,255,0.3);}
                    .recommendation-box { padding: 15px; border-radius: 8px; border-left: 4px solid;}
                    .recommendation-box.rec-strong-buy { background: rgba(0,255,136,0.1); border-left-color: #00ff88;}
                    .recommendation-box.rec-buy { background: rgba(0,212,255,0.1); border-left-color: #00d4ff;}
                    .recommendation-box.rec-watch { background: rgba(255,193,7,0.1); border-left-color: #ffc107;}
                    .recommendation-box.rec-avoid { background: rgba(255,107,53,0.1); border-left-color: #ff6b35;}
                    .rec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
                    .rec-action { font-size: 20px; font-weight: bold; }
                    .rec-confidence { font-size: 14px; opacity: 0.8; }
                    .rec-score { font-size: 16px; margin-bottom: 15px; }
                    .warnings-section, .reasons-section { margin-top: 15px; }
                    .warnings-section h4, .reasons-section h4 { margin: 0 0 10px 0; font-size: 16px; }
                    .warning-list, .reason-list { margin: 0; padding-left: 20px; }
                    .warning-list li, .reason-list li { margin-bottom: 5px; line-height: 1.4; }
                    .link-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
                    .external-link { display: inline-block; padding: 8px 16px; background: rgba(0,212,255,0.2); border: 1px solid rgba(0,212,255,0.5); color: #00d4ff; text-decoration: none; border-radius: 6px; font-size: 14px; transition: all 0.3s ease;}
                    .external-link:hover { background: rgba(0,212,255,0.3); transform: translateY(-1px);}
                    .modal-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; justify-content: flex-end; }
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                    @media (max-width: 768px) {
                        .modal-content { width: 95%; margin: 20px; }
                        .detail-grid { grid-template-columns: 1fr; }
                        .modal-footer { flex-direction: column; }
                    }
                    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
                </style>
            `);
        }

        document.body.appendChild(modal);

        // Click outside closes modal
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeTokenDetailsModal();
        });
    }

    function closeTokenDetailsModal() {
        const modal = document.getElementById('token-details-modal');
        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                modal.remove();
            }, 300);
        }
    }

    function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success');
        }).catch(() => {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Copied to clipboard!', 'success');
        });
    }

    // Render recent activity
    function renderRecentActivity() {
        const tbody = document.getElementById('recent-activity');
        tbody.innerHTML = '';
        if (dashboardData.recentActivity.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No recent activity...</td></tr>';
            return;
        }
        dashboardData.recentActivity.forEach(activity => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${activity.time}</td>
                <td>${activity.token}</td>
                <td><span class="chain-badge chain-${activity.chain}">${activity.chain.toUpperCase()}</span></td>
                <td><span class="risk-badge risk-${activity.risk}">${activity.risk}</span></td>
                <td><span class="recommendation rec-${activity.recommendation.toLowerCase().replace('_', '-')}">${activity.recommendation}</span></td>
                <td><button class="action-button" onclick="executeTrade('${activity.token}')">Trade</button></td>
            `;
            tbody.appendChild(row);
        });
    }

    // Event handlers
    function refreshData() {
        const spinner = document.getElementById('refresh-spinner');
        const text = document.getElementById('refresh-text');
        spinner.style.display = 'inline-block';
        text.textContent = 'Refreshing...';
        loadRealData().then(() => {
            spinner.style.display = 'none';
            text.textContent = 'Manual Refresh';
            showNotification('Data refreshed successfully', 'success');
        }).catch(() => {
            spinner.style.display = 'none';
            text.textContent = 'Manual Refresh';
            showNotification('Refresh failed', 'error');
        });
    }

    function clearOpportunities() {
        dashboardData.opportunities = [];
        updateStats();
        renderOpportunities();
    }

    function executeTrade(token) {
        showNotification(`Trade execution for ${token} - Feature coming soon!`, 'info');
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()">×</button>
        `;
        let container = document.getElementById('notifications');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notifications';
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                max-width: 400px;
            `;
            document.body.appendChild(container);
        }
        container.appendChild(notification);
        setTimeout(() => {
            if (notification.parentElement) notification.remove();
        }, 5000);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>

</body>
</html>